---
title: "Monthly Evaluation "
author: "Andy"
output: html_document
---


<br>  

```{r setup, include=FALSE}
library(tm)
library(wordcloud)
library(ggwordcloud)
library(lubridate)
library(ggthemes)
library(psych)
library(gridExtra)
library(lubridate)
library(tidyverse)
theme_set(theme_classic())
```


```{r, include=FALSE}
cur_month = month(Sys.Date())

if (nchar(cur_month - 1) == 1 & cur_month != 1){
  previous_month = cur_month - 1  
  previous_month_str = paste0("0", previous_month, '/')
} else if (cur_month == 1){
  previous_month = 12
  previous_month_str = paste0(previous_month, '/')
} else {
  previous_month = cur_month - 1
  previous_month_str = paste0(previous_month, '/')
}
cur_year = year(Sys.Date())
if(cur_month == 1){
  cur_year = cur_year - 1
}

cur_year_str = paste0('/',cur_year)
```

# **`r paste0(month.name[previous_month], ' ', cur_year)`**

<br>  

![](`r paste0('/Volumes/Programming/Spring 2022/DANL 310/my_website/aLin-96.github.io/monthly_eval_images/', month.abb[previous_month], cur_year)`.jpg)

<br>  


```{r, include=FALSE}
all_dat = read.csv('/Volumes/Programming/Spring 2022/project/all_dat.csv')
morning_rt = read.csv('/Volumes/Programming/Spring 2022/Project/morning_routine.csv')

colnames(all_dat) <- c('X', 'Name','Finished','Multiple','Phone_pickups',
                       'Screen_time','Created','Date','Drink',
                       'Meditation','Mentality','Satisfaction',
                       'Reading','Productivity','Rise_time','Run','Social',
                       'Tech','Total','Total_todo','Work_done','Key_words')


# Remove unnecessary columns & Modify some columns
all_dat <- all_dat %>%
  dplyr::select(Date, everything(), Finished, Total_todo,-X,-Name,-Created, - Work_done) %>%
  dplyr::mutate(work_finished = round(Finished/Total_todo,4)*100,
                Drink = lag(Drink),
                Total = Total*100) %>%
  dplyr::filter(Multiple < 6) %>%
  tibble()

all_dat_modified <- all_dat %>%
  filter(Social != 0) %>%
  mutate(Date = mdy(Date),
         Tech = as.factor(Tech),
         Productivity = as.factor(Productivity),
         Satisfaction = as.factor(Satisfaction),
         Social = as.factor(Social)) 

all_dat$Date[1:length(all_dat$Date)] = format(mdy(all_dat$Date[1:length(all_dat$Date)]),"%m/%d/%Y")

morning_rt <- morning_rt %>%
  mutate(Date = mdy(Date),
         morning_phone = rise_time_check, # modify column name 
         night_phone = before_sleep_check) %>%
  select(Date, everything(), -c(X, level_0, index, 
                                rise_time_check, before_sleep_check)) %>%
  tibble()

```


```{r, warning=FALSE, message=FALSE, include=FALSE}
words_dat_all <- all_dat %>%
  select(Key_words, Date) %>%
  filter(Key_words != 0 & Key_words != '' & Key_words != '[]') %>%
  mutate(Key_words = gsub('[\']','',Key_words),
         Key_words = gsub('[\\[]','',Key_words),
         Key_words = gsub('\\]','',Key_words)) %>%
  separate(Key_words, c('word_1', 'word_2', 'word_3'), sep = ',') %>%
  pivot_longer(cols = starts_with("word"), names_to = 'word_num', values_to = 'words') %>%
  mutate(words = gsub(" ", "", words)) %>%
  group_by(words) %>%
  dplyr::summarise(freq = n()) %>%
  arrange(desc(freq)) %>%
  filter(freq != 1)

words_dat_month <- all_dat %>%
  select(Key_words, Date) %>%
  filter(startsWith(Date, previous_month_str) == TRUE &
         endsWith(Date, cur_year_str) == TRUE) %>%
  filter(Key_words != 0 & Key_words != '' & Key_words != '[]') %>%
  mutate(Key_words = gsub('[\']','',Key_words),
         Key_words = gsub('[\\[]','',Key_words),
         Key_words = gsub('\\]','',Key_words)) %>%
  separate(Key_words, c('word_1', 'word_2', 'word_3'), sep = ',') %>%
  pivot_longer(cols = starts_with("word"), names_to = 'word_num', values_to = 'words') %>%
  mutate(words = gsub(" ", "", words)) %>%
  group_by(words) %>%
  dplyr::summarise(freq = n()) %>%
  arrange(desc(freq))


```


## Daily Words

---  

<font size="4">Every day, I define my day with three unique words. With the collected data(words), I could demonstrate the most frequent words in a monthly or even broader scope. Then, a word cloud could be created using the calculated frequencies.</font>

<br>  


### Daily Word Frequency  

<br>  


::: {.column width="49%" data-latex="{49\textwidth}"}

<font size="3">**`r month.name[previous_month]` Frequency**</font>  

```{r, warning=FALSE, message=FALSE, echo = FALSE}
rmarkdown::paged_table(head(words_dat_month, 10))

```


:::

::: {.column width="49%" data-latex="{49\textwidth}"}

<font size="3">**All_dat Frequency**</font>  

```{r, warning=FALSE, message=FALSE, echo = FALSE}
rmarkdown::paged_table(head(words_dat_all, 10))

```


::::::


::: {.column width="49%" data-latex="{49\textwidth}"}  

<br>  

<font size="3">**`r month.name[previous_month]` Word Cloud**</font>  

```{r, echo = FALSE, eval = TRUE, fig.width = 5, fig.height = 4,  warning = FALSE, fig.align="center"}
wordcloud(words = words_dat_month$words, freq = words_dat_month$freq, min.freq = .01,           
          max.words=70, random.order=FALSE, rot.per=0.35,            
          colors=brewer.pal(8, "Dark2"))
```

:::

::: {.column width="49%" data-latex="{49\textwidth}"}

<br>  

<font size="3">**All_dat Word Cloud**</font>  

```{r, echo = FALSE, eval = TRUE, fig.width = 5, fig.height = 4,  warning = FALSE, fig.align="center"}
wordcloud(words = words_dat_all$words, freq = words_dat_all$freq, min.freq = .01,           
          max.words=70, random.order=FALSE, rot.per=0.35,            
          colors=brewer.pal(8, "Dark2"))
```

::::::




<br>  

```{r, warning=FALSE, message=FALSE, include=FALSE}
month_dat <- all_dat %>%
  filter(startsWith(Date, previous_month_str) == TRUE &
         endsWith(Date, cur_year_str) == TRUE) %>%
  mutate(Date = mdy(Date),
         Tech = as.factor(Tech),
         Productivity = as.factor(Productivity),
         Satisfaction = as.factor(Satisfaction),
         Social = as.factor(Social)) 

# merge morning_rt with all_dat
month_dat <- merge(month_dat, morning_rt,by="Date", all.x=T) %>%
  select(-c(rise_time_min)) %>% # redundant
  arrange(Date) %>%
  tibble()
```


<br>  
<br>  


## `r paste0(month.name[previous_month])` vs Other Months

---  


```{r, warning=FALSE, message=FALSE, echo=FALSE}
# Get past 3 preceding months
if(previous_month <= 12){
  previous_3 = (previous_month - 3):(previous_month - 1)
}else if(previous_month == 1){
  previous_3 = 10:12
}else if(previous_month == 2){
  previous_3 = c(11,12,1)
}else if(previous_month == 3){
  previous_3 = c(12,1,2)
}

# Get preceding month
pprevious_month = previous_3[3]

# Fill Na's
all_dat[is.na(all_dat)] = 0


# Summary: ALL_dat (AVG)
all_summary <- as.data.frame(all_dat %>%
  dplyr::summarise(Total_avg = mean(Total),
            Meditation_avg = mean(Meditation),
            Reading_avg = mean(Reading),
            work_finished_avg = mean(work_finished),
            Multiple_avg = mean(Multiple)))
  
# Summary: 3 preceding months (AVG)
previous3_summary <- as.data.frame(all_dat %>%
  mutate(Date = mdy(Date)) %>%
  filter(month(Date) %in% previous_3 & year(Date) == cur_year) %>%
  dplyr::summarise(Total_avg = mean(Total),
            Meditation_avg = mean(Meditation),
            Reading_avg = mean(Reading),
            work_finished_avg = mean(work_finished),
            Multiple_avg = mean(Multiple)))

# Summary: 1 preceding month (AVG)
preced_month_summary <- as.data.frame(all_dat %>%
  mutate(Date = mdy(Date)) %>%
  filter(month(Date) == pprevious_month & year(Date) == cur_year) %>%
  dplyr::summarise(Total_avg = mean(Total),
            Meditation_avg = mean(Meditation),
            Reading_avg = mean(Reading),
            work_finished_avg = mean(work_finished),
            Multiple_avg = mean(Multiple)))

# Summary: previous month (AVG)
month_summary <- as.data.frame(month_dat %>%
  dplyr::summarise(Total_avg = mean(Total),
          Meditation_avg = mean(Meditation),
          Reading_avg = mean(Reading),
          work_finished_avg = mean(work_finished),
          Multiple_avg = mean(Multiple)))

rownames(all_summary) <- "All_Data"
rownames(previous3_summary) <- "Previous_3_months"
rownames(preced_month_summary) <- month.name[pprevious_month]
rownames(month_summary) <- month.name[previous_month]

summary_comparison = rbind(all_summary,previous3_summary, preced_month_summary, month_summary)
rmarkdown::paged_table(summary_comparison)

```

<br>  

```{r, echo = FALSE, eval = TRUE, fig.width = 10, fig.height = 6,  warning = FALSE, message=FALSE}
library(rstatix)


summary.stats <- all_dat %>%
  mutate(Date = mdy(Date),
         work_finished = work_finished) %>%
  group_by(month(Date), year(Date)) %>%
  get_summary_stats() %>%
  rename(month = `month(Date)`,
         year = `year(Date)`) %>%
  filter(variable %in% c('Total','Meditation', 'Reading', 'work_finished',
                         'Productivity', 'Mentality', 'Satisfaction', 'Tech', 'Social',
                         'Screen_time')) %>%
  filter((month %in% previous_3 | month == previous_month) & year == cur_year) %>%
  select(month, variable, n, median, mean, sd)



grading = c("Total", "work_finished")
multiple = c('Productivity', 'Mentality', 'Satisfaction', 'Tech', 'Social')
phone = c('Screen_time')

#summary.stats$month <- factor(summary.stats$month, levels = order(summary.stats$month, decreasing = T))

ggplot(filter(summary.stats, variable %in% grading & !variable %in% multiple)) +
        geom_col(aes(x = reorder(month.abb[month],month), y = mean, group = variable, fill = variable), position = "dodge", alpha = .7) +
        geom_line(aes(x = reorder(month.abb[month],month), y = mean, group = variable, color = variable)) + 
        ylim(0,100) + 
        labs(title = "Total & Work Finished Comparison (Past 3 Months)",
             subtitle = "Demonstrates Productivity Level(work_finished) & Overall Percentage(Total)\n",
             x = "Month", y = "Mean (Total, Work_finished)")+
        scale_fill_manual(values = c("#FBBC97", "#BEC5D6")) + 
        scale_color_manual(values = c("#FBBC97", "#BEC5D6")) + 
        theme(legend.position = "top", legend.title=element_blank())

```

```{r, echo = FALSE, eval = TRUE, fig.width = 10, fig.height = 10.7,  warning = FALSE, message=FALSE}

g1 <- ggplot(filter(summary.stats, !variable %in% grading & !variable %in% multiple &
                      !variable %in% phone)) +
        geom_col(aes(x = reorder(month.abb[month],month), y = mean, 
                     group = variable, fill = variable), position = "dodge") +
        labs(title = "Meditation, Reading Comparison (Past 3 Months)",
             subtitle = "Average minutes in Meditation & Reading\n",
             x = "Month", y = "Mean (min)") +
    theme(legend.position = "top")

g2 <- ggplot() +
    geom_density(data = filter(all_dat, Reading < 50), 
                 aes(x = Reading, y = ..scaled..,fill = "All_dat"), se = F, alpha = .15) +
    geom_density(data = filter(all_dat, Reading < 50 
                               & month(mdy(Date)) == pprevious_month 
                               & year(mdy(Date)) == cur_year), 
                 aes(x = Reading, y = ..scaled..,fill = paste0(month.abb[pprevious_month], '_dat')), 
                 se = F, alpha = .15) +
    geom_density(data = month_dat,
                 aes(x = Reading, y = ..scaled.., fill = paste0(month.abb[previous_month], '_dat')), 
                 se = F, alpha = .6) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    labs(title = "Reading (min) Distributions",
             x = "Reading (min)", y = "Scaled Percentage (%)") +
    theme(legend.position = "top", 
          axis.text.y = element_blank())

  
# Add groups for Rise time Boxplot
all_dat <- all_dat %>%
  mutate(Rise_time_group = case_when(month(mdy(Date)) == pprevious_month & 
                              year(mdy(Date)) == cur_year ~ paste0(month.abb[pprevious_month], '_dat'),
                              month(mdy(Date)) == previous_month & 
                              year(mdy(Date)) == cur_year ~ paste0(month.abb[previous_month], '_dat'),
                              TRUE ~ 'All_dat'))
all_dat$Rise_time_group <- factor(all_dat$Rise_time_group, levels = c("All_dat",
     paste0(month.abb[pprevious_month], '_dat'), 
     paste0(month.abb[previous_month], '_dat')))

g3 <- ggplot(month_dat) +
        geom_boxplot(data = filter(all_dat),
                     aes(Rise_time, group = Rise_time_group, color = Rise_time_group)) +
     coord_flip() +
     theme(axis.title.x=element_blank(),
           axis.text.x=element_blank(),
           axis.ticks.x=element_blank()) +
     labs(title = "\nRise Time Distribution", 
          subtitle = "Negative value: Rose earlier than intended\nPositive value: Rose later than intended\n",
          x = "Rise Time (min)")


g4 <- ggplot(filter(summary.stats, variable %in% phone)) +
        geom_smooth(aes(x = reorder(month.abb[month],month), y = mean, group = variable, color = variable)) +
        labs(title = "\nScreen time (min)",
             subtitle = "Lower Screen time helps achieve higher productivity level\n",
             x = "Month", y = "Mean (min)") + 
        theme(legend.position = "None")

g5 <- ggplot(filter(summary.stats, variable %in% multiple)) +
        geom_col(aes(x = reorder(month.abb[month],month), y = mean, group = variable, fill = variable), position = "dodge") +
        ylim(0,5) + 
        labs(title = "\nSubjective Evaluation - Bar",
             subtitle = "1: Worst\n5: Best\n",
             x = "Month", y = "Mean") + 
        theme(legend.position="bottom", legend.title=element_blank())

g6 <- ggplot(filter(summary.stats, variable %in% multiple)) +
        geom_smooth(aes(x = reorder(month.abb[month],month), y = mean, group = variable, color = variable), position = "dodge") +
        labs(title = "\nSubjective Evaluation - Line",
             subtitle = "1: Worst\n5: Best\n",
             x = "Month", y = "Mean") + 
        theme(legend.position="bottom", legend.title=element_blank())

grid.arrange(g1, g2, g3, g4, g5, g6, ncol = 2)
```

<br>  
<br>  


## Trends & Time Series  

---  


```{r, echo = FALSE, eval = TRUE, fig.width = 10, fig.height = 6,  warning = FALSE, message=FALSE}
comparison_month = all_dat %>%
  mutate(Date = mdy(Date)) %>%
  filter((month(Date) == pprevious_month & year(Date) == cur_year))

comparison_month <- merge(comparison_month, morning_rt,by="Date", all.x=T) %>%
  select(-c(rise_time_min)) %>% # redundant
  filter(!is.na(total_checked)) %>%
  arrange(Date) %>%
  tibble()

ggplot() +
  geom_line(data = comparison_month, aes(x = day(Date), y = Total, 
                                   color = paste0('Month_', pprevious_month)), 
            alpha = .3) +
  geom_line(data = month_dat, aes(x = day(Date), y = Total, 
                                   color = paste0('Month_',previous_month)), 
            alpha = .3) +
  geom_smooth(data = comparison_month, aes(x = day(Date), y = Total, 
                                   color = paste0('Month_', pprevious_month)), 
              se = F, size = 1.5, alpha = .2) +
  geom_smooth(data = month_dat, aes(x = day(Date), y = Total, 
                                   color = paste0('Month_',previous_month)), 
              se = F,size = 1.5, alpha = .2) + 
  ylim(0,100) +
  labs(title = paste0("DAILY TREND: ", month.abb[previous_month], " vs Preceding Month\n"),
       subtitle = paste0(month.abb[pprevious_month], 
                         " AVG: ", 
                         as.character(round(mean(comparison_month$Total),2)),
                         "\n",
                         month.abb[previous_month], 
                         " AVG: ", 
                         as.character(round(mean(month_dat$Total), 2))),
       color = "Legend",
       x = "Day", y = "Total %")

```


<br>  

```{r, echo = FALSE, eval = TRUE, fig.width = 10, fig.height = 6,  warning = FALSE, message=FALSE}

    
all_dat %>% 
        mutate(Date = mdy(Date)) %>%
        filter((month(Date) %in% previous_3 | month(Date) == previous_month) & 
                 year(Date) == cur_year) %>%
  ggplot()+
    geom_line(aes(x = Date, y = Total)) +
    geom_smooth(aes(x = Date, y = Total, color = "red"), alpha = .2) + 
  geom_smooth(aes(x = Date, y = Total, color = "red"), method = "lm", linetype = "dashed", se = F) + 
  labs(title = "TIME SERIES: Past 4 Months\n") +
  theme(legend.position = "None")

```



```{r, echo = TRUE, eval = TRUE, fig.width = 10, fig.height = 5,  warning = FALSE, include=FALSE}
g1 <- ggplot(data = all_dat_modified) +
  geom_bar(aes(x = Productivity, fill = Tech)) +
  guides(fill=guide_legend(title="Tech Consumption\n1: Worst, 5: Best")) +
  labs(title = "ALL Data: Productivity & Tech Consumption\n")


g2 <- ggplot(data = month_dat) +
  geom_bar(aes(x = Productivity, fill = Tech)) +
  guides(fill=guide_legend(title="Tech Consumption\n1: Worst, 5: Best")) +
  labs(title = paste0(month.abb[previous_month], " Data: Productivity & Tech Consumption\n"))

grid.arrange(g1, g2, ncol = 2)
```



<br>  

## `r month.name[previous_month]` - Correlations  

---  

```{r, echo = FALSE, eval = TRUE, fig.width = 9, fig.height = 5, fig.asp = .75,  warning = FALSE}

correlation_plot <- month_dat %>%
  select(c(Screen_time, Drink, Meditation, 
           Reading, Rise_time, Multiple, work_finished,
           night_phone, morning_phone))

pairs.panels(correlation_plot, lm = TRUE)

```

<br>  

### Productivity Level(Work_finished): Meditation

```{r, echo = FALSE, eval = TRUE, fig.width = 10, fig.height = 5,  warning = FALSE, message = FALSE}
all_dat_modified <- all_dat_modified %>%
  mutate(reading_group = case_when(Reading == 0 ~ '0',
                                   Reading < 10 ~ '<10',
                                   Reading < 20 ~ '<20',
                                   Reading < 30 ~ '<30',
                                   Reading > 29 ~ '>30'))

all_dat_modified$reading_group = factor(all_dat_modified$reading_group, levels = c('0', '<10', '<20', '<30', '>30'))

month_dat <- month_dat %>%
  mutate(reading_group = case_when(Reading == 0 ~ '0',
                                   Reading < 10 ~ '<10',
                                   Reading < 20 ~ '<20',
                                   Reading < 30 ~ '<30',
                                   Reading > 29 ~ '>30'))

month_dat$reading_group = factor(month_dat$reading_group, levels = c('0', '<10', '<20', '<30', '>30'))

ggplot(data = all_dat_modified) + 
    geom_smooth(aes(x = Meditation, y = work_finished, color = "All_dat"), se = F) +
    geom_smooth(data = filter(all_dat_modified, 
                              month(Date) == pprevious_month 
                               & year(Date) == cur_year), 
                aes(x = Meditation, y = work_finished, 
                    color = paste0(month.abb[pprevious_month], '_dat')), se = F) +
    geom_smooth(data = month_dat, aes(x = Meditation, y = work_finished, 
    color = paste0(month.abb[previous_month], '_dat')), se = F)

```

<br>  


### Productivity Level: Tech Consumption

```{r, echo = FALSE, eval = TRUE, fig.width = 10, fig.height = 5,  warning = FALSE, message = FALSE}
g1 <- ggplot(data = all_dat_modified) + 
    geom_smooth(aes(x = Screen_time, y = work_finished, color = Productivity),
              se = F) +
  labs(title = "ALL Data: Productivity & Tech Consumption")
g2 <- ggplot(data = month_dat) + 
    geom_smooth(aes(x = Screen_time, y = work_finished, color = Productivity),
              se = F) +
  labs(title = paste0(month.abb[previous_month], " Data: Productivity & Tech Consumption"))

grid.arrange(g1, g2, ncol = 2)
```


